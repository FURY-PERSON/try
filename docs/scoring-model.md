# Scoring Model v2 — Факт или Фейк

## Статус
Проект документа. Требуется имплементация на сервере и мобильном приложении.

---

## 1. Текущая система (v1)

| Компонент | Значение |
|-----------|----------|
| Базовые очки за правильный ответ | 100 |
| Speed bonus (макс.) | 50 (= max(0, 50 - timeSpentSeconds)) |
| Streak влияние | Нет |
| Неправильный ответ | 0 очков |

**Проблемы v1:**
- Streak никак не мотивирует игрока — нет разницы между серией из 1 и 20 правильных ответов.
- Инфляция очков: 100 + 50 за каждый ответ слишком много, лидерборд быстро переполняется большими числами.
- Speed bonus доминирует — быстрый угадчик набирает больше, чем вдумчивый игрок.

---

## 2. Новая система (v2)

### 2.1 Базовые очки

| Результат | Очки |
|-----------|------|
| Правильный ответ | **1** |
| Неправильный ответ | **0** |

### 2.2 Streak-бонус

Streak — количество **подряд правильных ответов** в рамках одной сессии (daily set, коллекция, категория). Streak сохраняется между сессиями в поле `User.currentStreak` и сбрасывается при первом неправильном ответе.

| Длина streak | Бонус-множитель | Итого за ответ |
|-------------|----------------|---------------|
| 1-2 | +0% | 1 очко |
| 3-5 | +10% | 1.1 очка |
| 6-9 | +25% | 1.25 очка |
| 10-14 | +50% | 1.5 очка |
| 15+ | +100% | 2 очка |

### 2.3 Формула расчёта

```
streakMultiplier = getStreakMultiplier(currentStreak)
pointsForAnswer = isCorrect ? Math.round(1 * (1 + streakMultiplier)) : 0
```

Где `getStreakMultiplier`:
```typescript
function getStreakMultiplier(streak: number): number {
  if (streak >= 15) return 1.0;
  if (streak >= 10) return 0.5;
  if (streak >= 6) return 0.25;
  if (streak >= 3) return 0.1;
  return 0;
}
```

### 2.4 Пример сессии (15 вопросов, все правильные)

| Вопрос | Streak | Множитель | Очки | Накопительно |
|--------|--------|-----------|------|-------------|
| 1 | 1 | +0% | 1 | 1 |
| 2 | 2 | +0% | 1 | 2 |
| 3 | 3 | +10% | 1 | 3 |
| 4 | 4 | +10% | 1 | 4 |
| 5 | 5 | +10% | 1 | 5 |
| 6 | 6 | +25% | 1 | 6 |
| 7 | 7 | +25% | 1 | 7 |
| 8 | 8 | +25% | 1 | 8 |
| 9 | 9 | +25% | 1 | 9 |
| 10 | 10 | +50% | 2 | 11 |
| 11 | 11 | +50% | 2 | 13 |
| 12 | 12 | +50% | 2 | 15 |
| 13 | 13 | +50% | 2 | 17 |
| 14 | 14 | +50% | 2 | 19 |
| 15 | 15 | +100% | 2 | 21 |

**Максимум за идеальный daily set (15/15):** 21 очко.
**Минимум за daily set (1/15 правильный):** 1 очко.

### 2.5 Speed bonus

**Убран.** В v2 скорость не влияет на очки. Причины:
- Упрощает модель.
- Убирает мотивацию угадывать вместо вдумчивого чтения.
- `timeSpentSeconds` продолжает сохраняться для аналитики, но не влияет на score.

---

## 3. Streak — правила

### 3.1 Сохранение между сессиями
- `User.currentStreak` сохраняется в БД и переносится между сессиями.
- При неправильном ответе streak сбрасывается в 0.
- `User.bestStreak` обновляется, если `currentStreak > bestStreak`.

### 3.2 Все режимы игры
Streak обновляется во **всех** режимах:
- Daily Set (`daily-sets.service.ts`)
- Коллекции (`collections.service.ts`)
- Категории (через `collections.service.ts`)
- По сложности (через `collections.service.ts`)

---

## 4. Лидерборд

Лидерборд сортируется по `score` (сумма очков за daily set). При равном score — по `totalTimeSeconds` (меньше = лучше).

---

## 5. Миграция

### Что нужно изменить:
1. **Сервер — `daily-sets.service.ts`:** Заменить формулу score (100 + speedBonus → 1 * streakMultiplier).
2. **Сервер — `collections.service.ts`:** Аналогичная замена формулы score.
3. **Сервер — общая функция:** Вынести `getStreakMultiplier()` и `calculateScore()` в `server/src/modules/shared/scoring.ts`.
4. **Мобильное приложение:** Обновить отображение очков на экране результатов (числа станут меньше).
5. **Лидерборд:** Учесть новую шкалу при отображении.

### Обратная совместимость
- Старые записи лидерборда используют старую шкалу. Рекомендуется **сбросить лидерборд** при выкатке v2 или добавить поле `scoringVersion` в `LeaderboardEntry`.

---

## 6. Резюме

| Параметр | v1 | v2 |
|----------|-----|-----|
| Базовые очки | 100 | 1 |
| Speed bonus | До 50 | Нет |
| Streak bonus | Нет | +10% / +25% / +50% / +100% |
| Макс. за 15/15 | 2250 | 21 |
| Мотивация streak | Нет | Да |
