# Фаза 2 — Дополнение: Лидерборд по очкам/стрику + Единая высота карточек коллекций

## Изменения к существующим требованиям

---

## 1. FR-071 (обновление): Лидерборд — расширение типов ранжирования

### Текущее состояние
FR-071 определяет лидерборд только **по количеству правильных ответов** с вкладками по периодам (неделя/месяц/год/всё время).

### Новое требование
Лидерборд расширяется **двумя дополнительными режимами ранжирования**: по очкам (score) и по стрику (streak).

---

**FR-071a: Лидерборд по очкам (Score Leaderboard)**
- Приоритет: Must
- Релиз: v1.1
- User Story: Как пользователь, я хочу видеть рейтинг игроков по набранным очкам, чтобы соревноваться не только по количеству правильных ответов, но и по общей результативности.

- Описание: Новая вкладка/переключатель «По очкам» в экране лидерборда. Ранжирование по суммарному полю `score` из `LeaderboardEntry`. Очки учитывают не только правильность, но и скорость ответа и сложность вопросов (формула подсчёта — в FR-015). Доступны те же периоды: неделя, месяц, год, всё время.

- Критерии приёмки:
  - AC-1: Когда пользователь открывает лидерборд, тогда доступен переключатель режима: «По ответам» / «По очкам» / «По стрику»
  - AC-2: Когда выбран режим «По очкам», тогда таблица ранжируется по сумме `score` за выбранный период
  - AC-3: Когда показана запись в режиме «По очкам», тогда для каждого пользователя отображаются: позиция, никнейм, суммарные очки за период
  - AC-4: Когда текущий пользователь есть в таблице, тогда его строка выделена визуально
  - AC-5: Когда текущего пользователя нет в топ-100, тогда внизу показывается его позиция отдельно
  - AC-6: Когда переключается режим ранжирования, тогда выбранный период сохраняется

- Связанные экраны: Leaderboard Screen
- Зависимости: FR-071, FR-015
- Требует backend: Да
- API:
  - GET /api/v1/leaderboard/weekly?type=score — топ по очкам за неделю
  - GET /api/v1/leaderboard/monthly?type=score — топ по очкам за месяц
  - GET /api/v1/leaderboard/yearly?type=score — топ по очкам за год
  - GET /api/v1/leaderboard/alltime?type=score — топ по очкам за всё время
  - Query param `type`: `answers` (по умолчанию, текущее поведение) | `score` | `streak`
  - Формат ответа: `{ entries: [{ rank, userId, nickname, totalScore }], userPosition: number | null, totalPlayers: number }`

---

**FR-071b: Лидерборд по стрику (Streak Leaderboard)**
- Приоритет: Must
- Релиз: v1.1
- User Story: Как пользователь, я хочу видеть рейтинг игроков по длине стрика, чтобы мотивироваться играть каждый день.

- Описание: Новая вкладка «По стрику» в экране лидерборда. Ранжирование по текущему активному стрику (`currentStreak` из модели `User`). Это единый рейтинг (не разбивается на периоды), так как стрик — это непрерывная метрика. Дополнительно показывается лучший стрик (`bestStreak`) рядом с текущим.

- Критерии приёмки:
  - AC-1: Когда выбран режим «По стрику», тогда таблица ранжируется по `currentStreak` (текущий стрик)
  - AC-2: Когда показана запись в режиме «По стрику», тогда для каждого пользователя отображаются: позиция, никнейм, текущий стрик (дней), лучший стрик (дней)
  - AC-3: Когда у пользователя стрик = 0, тогда он НЕ отображается в лидерборде по стрику (минимум 1 день)
  - AC-4: Когда выбран режим «По стрику», тогда переключатель периодов скрывается (стрик не зависит от периода)
  - AC-5: Когда текущий пользователь есть в таблице, тогда его строка выделена визуально
  - AC-6: Когда текущего пользователя нет в топ-100, тогда внизу показывается его позиция отдельно
  - AC-7: Когда два пользователя имеют одинаковый currentStreak, тогда выше стоит тот, у кого выше bestStreak

- Связанные экраны: Leaderboard Screen
- Зависимости: FR-071, FR-050
- Требует backend: Да
- API:
  - GET /api/v1/leaderboard/streak — топ по текущему стрику
  - Формат ответа: `{ entries: [{ rank, userId, nickname, currentStreak, bestStreak }], userPosition: number | null, totalPlayers: number }`

---

### Изменения UI лидерборда

**Текущая структура экрана:**
```
[Вкладки периодов: Неделя | Месяц | Год | Всё время]
[Таблица: # | Никнейм | Правильных ответов]
```

**Новая структура экрана:**
```
[Переключатель режима: По ответам | По очкам | По стрику]
[Вкладки периодов: Неделя | Месяц | Год | Всё время]  ← скрыты в режиме «По стрику»
[Таблица: # | Никнейм | Значение метрики]
```

Переключатель режима реализовать как **SegmentedControl** (3 сегмента) над вкладками периодов.

---

### Изменения Backend

1. **Существующие эндпоинты** `/api/v1/leaderboard/{period}` получают query param `type`:
   - `type=answers` (по умолчанию) — текущее поведение
   - `type=score` — ранжирование по сумме `score`

2. **Новый эндпоинт** `GET /api/v1/leaderboard/streak`:
   - Возвращает топ-100 пользователей по `currentStreak DESC, bestStreak DESC`
   - Не требует параметра периода
   - Фильтр: `currentStreak > 0`

3. **Модель LeaderboardEntry** — без изменений (поле `score` уже есть)

4. **Модель User** — без изменений (поля `currentStreak`, `bestStreak` уже есть)

---

### Изменения модели данных

Нет изменений в Prisma-схеме — все необходимые поля уже существуют:
- `LeaderboardEntry.score` — для лидерборда по очкам
- `User.currentStreak` — для лидерборда по стрику
- `User.bestStreak` — для отображения лучшего стрика

---

### Аналитические события

| Событие | Параметры | Когда трекается |
|---------|-----------|-----------------|
| `leaderboard_type_switch` | `type` (answers/score/streak), `from_type` | Переключение режима лидерборда |
| `leaderboard_view` | `type`, `tab` (weekly/monthly/yearly/alltime/streak) | Просмотр лидерборда (обновить существующее событие) |

---

## 2. FR-NEW-001: Единая высота карточек коллекций

- Приоритет: Must
- Релиз: v1.1
- User Story: Как пользователь, я хочу видеть аккуратный горизонтальный список коллекций, где все карточки одной высоты, чтобы интерфейс выглядел опрятно.

- Описание: Карточки коллекций на главном экране (горизонтальный FlatList) в текущей реализации имеют переменную высоту из-за разной длины заголовков и описаний. Необходимо зафиксировать высоту всех карточек, чтобы они были визуально одинаковыми.

- Текущая реализация (проблема):
  ```
  collectionCard: {
    width: 180,
    padding: 16,
    gap: 6,
  }
  // Высота не задана → зависит от длины текста (numberOfLines ограничен, но lineHeight × maxLines различается)
  ```

- Решение:
  Задать фиксированную высоту (`minHeight`) для карточки. Текст заголовка и описания уже ограничен `numberOfLines={2}`, но контейнер не имеет фиксированной высоты. Нужно задать фиксированные высоты для текстовых блоков.

- Критерии приёмки:
  - AC-1: Когда на главном экране отображается горизонтальный список коллекций, тогда все карточки имеют одинаковую высоту
  - AC-2: Когда заголовок коллекции короткий (1 строка), тогда карточка занимает ту же высоту, что и карточка с длинным заголовком (2 строки)
  - AC-3: Когда описание коллекции короткое, тогда карточка занимает ту же высоту, что и карточка с длинным описанием
  - AC-4: Когда текст не помещается, тогда он обрезается с многоточием (numberOfLines сохранён)

- Связанные экраны: Home Screen (секция коллекций)
- Зависимости: —
- Требует backend: Нет

- Техническое решение (рекомендация для Mobile-разработчика):
  ```typescript
  // Вариант: задать фиксированные высоты текстовых контейнеров
  collectionTitle: {
    fontSize: 15,
    fontFamily: fontFamily.bold,
    lineHeight: 20,
    height: 40,  // 2 строки × 20 lineHeight = 40
  },
  collectionDesc: {
    fontSize: 13,
    fontFamily: fontFamily.regular,
    lineHeight: 18,
    height: 36,  // 2 строки × 18 lineHeight = 36
  },
  ```
  Итоговая фиксированная высота карточки:
  - padding top: 16
  - icon: 32
  - gap: 6
  - title: 40 (2 × 20)
  - gap: 6
  - desc: 36 (2 × 18)
  - gap: 6
  - count: 11 (1 строка)
  - padding bottom: 16
  - **Итого: ~169px**

---

## Резюме для дизайнера

| Экран | Изменения |
|-------|-----------|
| Leaderboard Screen | Добавить SegmentedControl с 3 режимами: «По ответам», «По очкам», «По стрику». В режиме «По стрику» скрыть вкладки периодов. Колонка таблицы меняется в зависимости от режима. |
| Home Screen (коллекции) | Все карточки коллекций в горизонтальном списке должны быть одной высоты. Зафиксировать высоты текстовых блоков. |

## Резюме для разработчиков

### Backend-разработчик:
1. Добавить query param `type` в существующие эндпоинты `/api/v1/leaderboard/{period}`
2. Создать новый эндпоинт `GET /api/v1/leaderboard/streak`
3. Изменений в БД не требуется

### Mobile-разработчик:
1. Обновить экран лидерборда — добавить SegmentedControl для переключения режимов
2. Адаптировать запросы к API с учётом нового query param `type`
3. Добавить экран/вкладку стрик-лидерборда (без периодов)
4. Зафиксировать высоту карточек коллекций на Home Screen
