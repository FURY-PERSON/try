# Фаза 2: Бизнес-аналитик — Обновление требований v5

> **Дата:** 2026-02-25
> **Статус:** Новые функциональные требования (3 FR)
> **Контекст:** Онбординг персонализации, админ-управление справочниками, редактирование профиля

---

## FR-205: Экран выбора никнейма и аватара при первом входе

**Приоритет:** Must
**Релиз:** v1.2

### User Story
Как новый пользователь, я хочу выбрать себе никнейм и аватар-эмоджи при первом входе, чтобы сразу персонализировать свой опыт, при этом не задерживаясь, если мне лень придумывать имя.

### Описание

После онбординга (шаг 3 — выбор языка) пользователю показывается **новый экран** (шаг 4), где он:

1. **Видит поле ввода никнейма** с предзаполненным плейсхолдером — случайно сгенерированным забавным именем в формате `"{Прилагательное} {Животное}"` (из справочника, FR-206).
2. **Видит аватар-эмоджи** — случайный эмоджи из справочника, отображаемый крупно над полем ввода. Пользователь может нажать на аватар, чтобы получить другой случайный эмоджи (рандомизация при каждом тапе).
3. **Нажимает кнопку "Поехали!" / "Let's go!"** для перехода на главный экран.

### Поведение

**Никнейм:**
- Плейсхолдер генерируется при входе на экран — случайная комбинация `{Adj} {Animal}` на выбранном языке (язык определён на шаге 3).
- Если пользователь **не вводил ничего** и нажал "Поехали!" — его никнейм = текст плейсхолдера.
- Если пользователь **ввёл своё имя** — валидация: минимум 3 символа, максимум 20 символов.
- При ошибке валидации — инлайн-сообщение под полем: "Минимум 3 символа" / "Min 3 characters".
- Уникальность никнейма не проверяется на клиенте (сервер добавит число при конфликте).

**Аватар-эмоджи:**
- При входе на экран — случайный эмоджи из справочника.
- Тап на аватар → анимация (легкий bounce) → новый случайный эмоджи (отличный от текущего).
- Эмоджи отображаются крупно (80px) в круглом контейнере с тонкой обводкой.

**Сохранение:**
- При нажатии "Поехали!" отправляется `PATCH /api/v1/users/me` с `{ nickname, avatarEmoji }`.
- Данные сохраняются в `useUserStore` (nickname, avatarEmoji).
- После успешного сохранения → переход на `/(tabs)/home`.
- При ошибке сети — данные всё равно сохраняются локально (offline-first), retry при следующем запросе.

### Навигация

Текущий онбординг: Step 1 → Step 2 → Step 3 (выбор языка → `finish()` → Home).

Новый флоу: Step 1 → Step 2 → Step 3 (выбор языка) → **Step 4 (никнейм + аватар)** → Home.

- Step 3 `finish(lang)` теперь ведёт на Step 4, а не на Home.
- Step 4 имеет кнопку "Пропустить" — при нажатии берётся плейсхолдер + текущий случайный эмоджи.
- Step 4 НЕ имеет кнопки "Назад" (язык уже выбран).

### Источник данных для плейсхолдера и эмоджи

Списки прилагательных, животных и эмоджи загружаются с сервера через API (`GET /api/v1/reference/nickname-options`). Если сервер недоступен — используются захардкоженные fallback-списки на клиенте (текущие массивы из `generate-nickname.ts`).

**Формат ответа API:**
```json
{
  "adjectives": [
    { "id": "...", "textRu": "Дерзкий", "textEn": "Bold" },
    ...
  ],
  "animals": [
    { "id": "...", "nameRu": "Лиса", "nameEn": "Fox", "emoji": "🦊" },
    ...
  ],
  "emojis": [
    { "id": "...", "emoji": "🦊" },
    { "id": "...", "emoji": "🐱" },
    ...
  ]
}
```

### UI/UX

```
┌──────────────────────────────┐
│                    Пропустить →│
│                               │
│         ┌─────────┐           │
│         │  🦊     │  ← тап   │
│         │  (80px) │    для    │
│         └─────────┘   смены   │
│                               │
│    Как тебя зовут?            │
│                               │
│  ┌─────────────────────────┐  │
│  │ Дерзкий Лис         ▏  │  │  ← плейсхолдер
│  └─────────────────────────┘  │
│       Можешь оставить или     │
│       придумать своё          │
│                               │
│       ● ● ● ●                │  ← dots (4-й активный)
│  ┌─────────────────────────┐  │
│  │      Поехали! 🚀        │  │
│  └─────────────────────────┘  │
└──────────────────────────────┘
```

### Критерии приёмки

- **AC-1:** После шага 3 (выбор языка) пользователь попадает на экран выбора никнейма и аватара.
- **AC-2:** В плейсхолдере инпута — случайное имя формата `"{Adj} {Animal}"` на выбранном языке.
- **AC-3:** Если пользователь нажал "Поехали!" с пустым полем — его никнейм = текст плейсхолдера.
- **AC-4:** Если пользователь ввёл менее 3 символов — показывается ошибка валидации, кнопка не работает.
- **AC-5:** Тап на эмоджи-аватар меняет его на другой случайный с bounce-анимацией.
- **AC-6:** Кнопка "Пропустить" берёт плейсхолдер и текущий эмоджи без валидации.
- **AC-7:** Данные сохраняются на сервер и в локальный стор.
- **AC-8:** Списки прилагательных/животных/эмоджи загружаются с сервера; при недоступности — fallback.
- **AC-9:** Дизайн экрана консистентен с остальным онбордингом (градиент, AnimatedEntrance, dots).
- **AC-10:** Индикатор прогресса (dots) показывает 4 точки, 4-я активная.

### Изменения в данных

Без изменений в Prisma-схеме (поля `nickname` и `avatarEmoji` уже есть в User).

### Изменения в навигации

- Добавить `app/(onboarding)/step-4.tsx`.
- Изменить `step-3.tsx` → `finish()` ведёт на step-4, а не на home.
- `step-4.tsx` → после сохранения → `completeOnboarding()` + navigate to home.

### API

- `GET /api/v1/reference/nickname-options` — публичный (без auth), возвращает справочники.
- `PATCH /api/v1/users/me` — уже существует, принимает `nickname` и `avatarEmoji`.

### i18n ключи

| Ключ | RU | EN |
|------|-----|-----|
| `onboarding.step4Title` | Как тебя зовут? | What's your name? |
| `onboarding.step4Desc` | Можешь оставить или придумать своё | Keep it or make your own |
| `onboarding.step4Button` | Поехали! 🚀 | Let's go! 🚀 |
| `onboarding.step4Skip` | Пропустить | Skip |
| `onboarding.nicknameMinLength` | Минимум 3 символа | Min 3 characters |
| `onboarding.tapToChange` | Нажми чтобы сменить | Tap to change |

### Связанные экраны
- Онбординг step-3 (изменение навигации)
- Новый step-4
- Home (после онбординга)

### Зависимости: FR-206 (справочники на сервере), FR-201 (avatarEmoji уже в схеме)
### Требует backend: Да (API reference/nickname-options)

---

## FR-206: Админ-панель — CRUD справочников имён и эмоджи

**Приоритет:** Must
**Релиз:** v1.2

### User Story
Как администратор, я хочу управлять списками прилагательных, животных и эмоджи-аватаров через веб-панель, чтобы добавлять, удалять и редактировать варианты без деплоя кода.

### Описание

В админ-панели (`web/`) добавляется новый раздел **"Справочники"** (Reference Data) с тремя вкладками:

1. **Прилагательные** (Adjectives) — таблица с полями: `textRu`, `textEn`, `isActive`, `sortOrder`.
2. **Животные** (Animals) — таблица с полями: `nameRu`, `nameEn`, `emoji`, `isActive`, `sortOrder`.
3. **Эмоджи-аватары** (Avatar Emojis) — таблица с полями: `emoji`, `label` (описание), `isActive`, `sortOrder`.

Каждая таблица поддерживает полный CRUD: создание, редактирование, удаление, переключение `isActive`.

### Prisma модели

```prisma
model NicknameAdjective {
  id        String   @id @default(cuid())
  textRu    String
  textEn    String
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NicknameAnimal {
  id        String   @id @default(cuid())
  nameRu    String
  nameEn    String
  emoji     String
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AvatarEmoji {
  id        String   @id @default(cuid())
  emoji     String   @unique
  label     String   @default("")
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### Seed данных

При миграции — seed текущих захардкоженных данных из `generate-nickname.ts` (20 прилагательных, 20 животных) и список всех эмоджи из животных + дополнительные.

### API эндпоинты

**Публичный:**
- `GET /api/v1/reference/nickname-options` — возвращает активные прилагательные, животные, эмоджи (без пагинации, кэш 1 час).

**Админские:**

| Endpoint | Method | Описание |
|----------|--------|----------|
| `/api/v1/admin/reference/adjectives` | GET | Список всех (включая неактивные) |
| `/api/v1/admin/reference/adjectives` | POST | Создать прилагательное |
| `/api/v1/admin/reference/adjectives/:id` | PATCH | Обновить |
| `/api/v1/admin/reference/adjectives/:id` | DELETE | Удалить |
| `/api/v1/admin/reference/animals` | GET | Список всех |
| `/api/v1/admin/reference/animals` | POST | Создать |
| `/api/v1/admin/reference/animals/:id` | PATCH | Обновить |
| `/api/v1/admin/reference/animals/:id` | DELETE | Удалить |
| `/api/v1/admin/reference/emojis` | GET | Список всех |
| `/api/v1/admin/reference/emojis` | POST | Создать |
| `/api/v1/admin/reference/emojis/:id` | PATCH | Обновить |
| `/api/v1/admin/reference/emojis/:id` | DELETE | Удалить |

### Обновление generate-nickname.ts

После миграции на БД `generateUniqueNickname()` должен:
1. Загружать активные прилагательные и животные из БД.
2. Если БД пуста — fallback на захардкоженные массивы.
3. Кэшировать в памяти на 5 минут (простой in-memory cache).

### UI админки

Паттерн аналогичен существующим страницам Categories и Collections:
- Таблица с колонками: текст RU, текст EN, эмоджи (для животных), статус (Active/Inactive badge), действия.
- Кнопка "Добавить" → модал с формой (React Hook Form + Zod).
- Inline toggle для isActive.
- Иконки Edit/Delete в строке.
- Tabs: "Прилагательные" | "Животные" | "Эмоджи".

```
┌──────────────────────────────────────────────────┐
│ Справочники                                       │
│                                                    │
│ [Прилагательные] [Животные] [Эмоджи]   [+ Добавить]│
│                                                    │
│ ┌────────────────────────────────────────────────┐ │
│ │ RU           EN          Статус    Действия    │ │
│ │ Дерзкий      Bold        ●Active   ✏️ 🗑      │ │
│ │ Мудрый       Wise        ●Active   ✏️ 🗑      │ │
│ │ Хитрый       Sly         ○Inactive ✏️ 🗑      │ │
│ │ ...                                            │ │
│ └────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────┘
```

### Критерии приёмки

- **AC-1:** В админ-панели есть раздел "Справочники" с тремя вкладками.
- **AC-2:** Каждая вкладка отображает таблицу с данными и поддерживает CRUD.
- **AC-3:** Можно переключать `isActive` для каждой записи.
- **AC-4:** При удалении — подтверждение через диалог.
- **AC-5:** Публичный API возвращает только активные записи.
- **AC-6:** При создании записи — валидация обязательных полей (textRu, textEn для прилагательных; nameRu, nameEn, emoji для животных; emoji для эмоджи).
- **AC-7:** `generateUniqueNickname` загружает данные из БД вместо хардкода.
- **AC-8:** Seed-скрипт заполняет таблицы текущими данными из массивов.
- **AC-9:** Публичный API `/reference/nickname-options` кэширует ответ.

### Связанные экраны
- Новая страница в админ-панели (`web/src/pages/ReferencePage.tsx`)
- Модуль `server/src/modules/reference/`

### Зависимости: Нет
### Требует backend: Да
### Требует web: Да

---

## FR-207: Редактирование никнейма и аватара в профиле

**Приоритет:** Must
**Релиз:** v1.2

### User Story
Как пользователь, я хочу иметь возможность изменить свой никнейм и аватар-эмоджи в любой момент через профиль, чтобы персонализировать свой аккаунт когда захочу.

### Описание

Расширить существующий модал редактирования никнейма (`app/modal/nickname.tsx`) — добавить выбор аватара-эмоджи. Также добавить возможность изменить аватар прямо с экрана профиля (тап на аватар).

### Поведение

**Из профиля:**
- Тап на **аватар** (эмоджи) → открывает модал с выбором эмоджи + редактированием никнейма (тот же модал).
- Тап на **имя** / иконку карандаша → тоже открывает этот модал.

**Модал редактирования (расширение текущего `nickname.tsx`):**

```
┌──────────────────────────────┐
│         Редактировать         │
│                               │
│         ┌─────────┐           │
│         │  🦊     │  ← тап   │
│         │  (64px) │    для    │
│         └─────────┘   смены   │
│                               │
│  ┌─────────────────────────┐  │
│  │ Дерзкий Лис          ▏ │  │
│  └─────────────────────────┘  │
│            3/20               │
│                               │
│  ┌─────────────────────────┐  │
│  │       Сохранить          │  │
│  └─────────────────────────┘  │
│  ┌─────────────────────────┐  │
│  │       Отмена             │  │
│  └─────────────────────────┘  │
└──────────────────────────────┘
```

**Никнейм:**
- Текущий никнейм предзаполнен в поле.
- Валидация: 3-20 символов.
- Если поле пустое и пользователь нажимает "Сохранить" — показывается ошибка "Введите имя".

**Аватар-эмоджи:**
- Текущий эмоджи показывается крупно.
- Тап → bounce-анимация → случайный эмоджи из справочника (загруженного с сервера или fallback).
- Список эмоджи тот же, что и в онбординге (FR-205, FR-206).

**Сохранение:**
- `PATCH /api/v1/users/me` с `{ nickname, avatarEmoji }`.
- Обновление `useUserStore`.
- При ошибке сети — показать toast "Не удалось сохранить" / "Failed to save", не закрывать модал.

### Критерии приёмки

- **AC-1:** Тап на аватар в профиле открывает модал редактирования.
- **AC-2:** Тап на имя / карандаш в профиле открывает тот же модал.
- **AC-3:** В модале отображаются текущие никнейм и аватар-эмоджи.
- **AC-4:** Тап на эмоджи в модале меняет его на случайный с анимацией.
- **AC-5:** Валидация никнейма: 3-20 символов, ошибка при пустом вводе.
- **AC-6:** "Сохранить" отправляет обновлённые данные на сервер.
- **AC-7:** После успешного сохранения — модал закрывается, данные обновлены в UI (профиль, лидерборд).
- **AC-8:** "Отмена" — закрывает модал без сохранения.
- **AC-9:** При ошибке сети — toast с сообщением, модал остаётся открытым.

### Изменения

- Расширить `app/modal/nickname.tsx` — добавить секцию аватар-эмоджи.
- Обновить `profileApi.updateProfile()` — отправлять `avatarEmoji`.
- В профиле: сделать аватар Pressable, открывающий модал.

### i18n ключи

| Ключ | RU | EN |
|------|-----|-----|
| `profile.editProfile` | Редактировать | Edit profile |
| `profile.enterName` | Введите имя | Enter name |
| `profile.saveFailed` | Не удалось сохранить | Failed to save |
| `profile.tapToChangeEmoji` | Нажми чтобы сменить | Tap to change |

### Связанные экраны
- Профиль (`app/(tabs)/profile/index.tsx`)
- Модал никнейма (`app/modal/nickname.tsx`)

### Зависимости: FR-205 (общие UX-паттерны), FR-206 (справочник эмоджи)
### Требует backend: Нет (API уже есть)

---

## Приоритет реализации

| # | FR | Описание | Сложность |
|---|-----|----------|-----------|
| 1 | FR-206 | Админ CRUD справочников | Высокая (server + web + миграция + seed) |
| 2 | FR-205 | Онбординг: выбор никнейма и аватара | Средняя (mobile, зависит от FR-206 API) |
| 3 | FR-207 | Редактирование профиля: никнейм + аватар | Низкая (расширение существующего модала) |

## Аналитические события

| Событие | Параметры | Когда |
|---------|-----------|-------|
| `onboarding_nickname_set` | `source: 'placeholder' \| 'custom'`, `length` | Завершение step-4 |
| `onboarding_avatar_changed` | `taps` (количество смен) | Завершение step-4 |
| `onboarding_nickname_skipped` | — | Кнопка "Пропустить" на step-4 |
| `profile_nickname_changed` | `oldLength`, `newLength` | Сохранение из профиля |
| `profile_avatar_changed` | `oldEmoji`, `newEmoji` | Сохранение из профиля |
| `admin_reference_created` | `type: 'adjective' \| 'animal' \| 'emoji'` | CRUD в админке |
| `admin_reference_deleted` | `type`, `id` | CRUD в админке |
